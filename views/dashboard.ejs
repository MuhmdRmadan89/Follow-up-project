<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<style>
body {
  background: #f5f7fb;
}

.order-card {
  border-radius: 15px;
  transition: 0.2s ease;
  border-left: 6px solid transparent;
}

.order-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 20px rgba(0,0,0,0.08);
}

.order-card.new-feedback {
  border-left: 6px solid #dc3545;
}

.badge-version {
  background: #0d6efd;
  font-size: 0.75rem;
}

.feedback-box {
  background: #ffffff;
  border-radius: 10px;
  padding: 10px;
  margin-bottom: 8px;
  border: 1px solid #eaeaea;
}
</style>
</head>

<body class="container py-4">

<h3 class="mb-4">Project Review System</h3>

<!-- CREATE ORDER -->
<div class="card shadow-sm p-3 mb-4">
  <h6>Create New Order</h6>
  <form method="POST" action="/admin/upload" enctype="multipart/form-data" class="row g-2">
    <div class="col-md-3">
      <input name="client_name" class="form-control" placeholder="Client Name" required>
    </div>
    <div class="col-md-3">
      <input name="client_phone" class="form-control" placeholder="Client Phone" required>
    </div>
    <div class="col-md-3">
      <input type="file" name="file" class="form-control" required>
    </div>
    <div class="col-md-2">
      <button class="btn btn-primary w-100">Create</button>
    </div>
  </form>
</div>

<!-- ORDERS -->
<div class="row g-4">

<% orders.forEach(o => { %>

<div class="col-md-6">
  <div class="card shadow-sm order-card <%= o.has_new_feedback ? 'new-feedback' : '' %> p-3">

    <div class="d-flex justify-content-between align-items-center mb-2">
      <div>
        <strong><%= o.client_name %></strong>
        <span class="badge badge-version ms-2">V<%= o.latest_version || 1 %></span>
      </div>

      <span class="badge 
        <%= o.status === 'Closed' ? 'bg-secondary' :
            o.status === 'Revision Requested' ? 'bg-danger' :
            'bg-primary' %>">
        <%= o.status %>
      </span>
    </div>

    <div class="mb-2 text-muted small">
      ID: <%= o.id %>
    </div>

    <!-- ACTIONS -->
    <div class="mb-3">
      <a href="/file/<%= o.latest_file %>" class="btn btn-dark btn-sm">Download</a>

      <a class="btn btn-success btn-sm"
      href="https://api.whatsapp.com/send?phone=<%= o.client_phone %>&text=<%= encodeURIComponent('تم رفع نسخة جديدة V' + o.latest_version + '، برجاء مراجعة الرابط: http://localhost:3000/review/' + o.token) %>"
      target="_blank">
      WhatsApp
      </a>

      <form method="POST" action="/admin/approve/<%= o.id %>" class="d-inline">
        <button class="btn btn-outline-success btn-sm">Close</button>
      </form>

      <form method="POST" action="/admin/delete/<%= o.id %>" class="d-inline">
        <button class="btn btn-outline-danger btn-sm">Delete</button>
      </form>
    </div>

    <!-- UPLOAD NEW VERSION -->
    <form method="POST" action="/admin/new-version/<%= o.id %>" enctype="multipart/form-data" class="mb-3">
      <div class="input-group input-group-sm">
        <input type="file" name="file" class="form-control" required>
        <button class="btn btn-primary">Upload New Version</button>
      </div>
    </form>

    <!-- FEEDBACK -->
    <div>
      <strong class="small text-muted">Feedback</strong>

      <% if (o.feedbacks.length > 0) { %>
        <% o.feedbacks.forEach(f => { %>
          <div class="feedback-box">
            <div><%= f.message %></div>
            <div class="text-muted small"><%= f.created_at %></div>
          </div>
        <% }) %>
      <% } else { %>
        <div class="text-muted small">No feedback yet.</div>
      <% } %>
    </div>

  </div>
</div>

<% }) %>

</div>

</body>
</html>